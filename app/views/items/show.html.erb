<% @page_title = @item.name %>

<div class="category">
  <%= link_to @item.category.category_name, items_path(category_id:@item.category_id), class: "category" %>
</div>
<div class="product-container">
  <div class="product-image">
    <% if @item.item_picture.attached? %>
      <%= image_tag @item.item_picture.variant(resize: "500x500") %>
    <% end %>
  </div>
  <div class="product-details">
    <h2 class="product-title"><%= @item.name %></h2>
    <p></p>
    <div class="product-price"><%= currency%><%= @item.price %> 税込</div>
    <hr>
    <p><%= @item.description %></p>
    <hr>
    <p></p>
  </div>
  <div class="product-price-box">
    <div class="item">
    <div class="product-condition"><%= @item.new? ? "新品" : "中古" %></div>
    <div class="product-price"><%= currency%><%= @item.price %><span class="product-price-smalltext">税込</span></div>
    <div class="product-status"><%= I18n.t("enums.item.status.#{@item.status}") %></div>
        <% if @item.available? %>
          <%= form_with url: cart_items_path, local: true do |form| %>
            <%= form.hidden_field :item_id, value: @item.id %>
            <% options = (1..[@item.stock, 10].min).to_a %> 
            <%= form.select :quantity, options  %>
            <%= form.submit "カートに入れる", class: "buy-button" %>
          <% end %>
        <% end %>
    </div>
    <table class = "seller-info">
      <tr>
        <th>出品者</th>
        <td><%=link_to @item.user.business_name , user_path(@item.user_id)%></td>
      </tr>
      <tr>
        <th>出品者の評価</th>
        <td>★★★★★</td>
      </tr>
    </table>
    <hr>
    <div class="product-toolbar">
      <% if current_user&.favorite_items&.exists?(item_id: @item.id) %>
        <p><%= link_to "お気に入りから削除", 
              item_favorite_item_path(@item, current_user.favorite_items.find_by(item_id: @item.id)), 
              method: :delete %></p>
      <% else %>
        <p><%= link_to "お気に入りに追加", item_favorite_items_path(@item), method: :post %></p>
      <% end %>
    </div>
  </div>
</div>
<div class="item-info">
  <h3>詳細情報</h3>
  <table class = "item-info-table">
      <tr>
        <th width="150"> 商品ID</th>
        <td><%= @item.id %></td>
      </tr>
      <tr>
        <th>商品名</th>
        <td><%= @item.name %></td>
      </tr>
      <tr>
        <th>コード</th>
        <td><%= @item.code %></td>
      </tr>
      <tr>
        <th>カテゴリ</th>
        <td><%= @item.category.category_name %></td>
      </tr>
      <tr>
        <th>在庫数</th>
        <td><%= @item.stock %></td>
      </tr>
      <tr>
        <th>価格（税込）</th>
        <td><%= @item.price %></td>
      </tr>
      <tr>
        <th>コンディション</th>
        <td><%= @item.new? ? "新品" : "中古" %></td>
      </tr>
      <tr>
        <th>出品状態</th>
        <td><%= I18n.t("enums.item.status.#{@item.status}") %></td>
      </tr>
      <tr>
        <th>最終更新日時</th>
        <td><%= @item.updated_at %></td>
      </tr>
    </table>
  <h3>商品説明</h3>
  <p><%= @item.description %></p>
  <h3>カスタマーレビュー</h3>
  <p><%= link_to "レビューを書く", new_item_review_path(@item) %></p>
  <% if @item.reviews.present? %>
    <% @item.reviews.each do |review| %>
      <div class="review">
        <div class="review-rating">評価：<%= review.rating %>点</div>
        <div class="review-date"><%= review.created_at.strftime('%Y年%m月%d日')%>にレビュー済み</div>
        <div class="review-content"><%= review.content %></div>
        <div class="review-user">by <%= review.user.full_name %></div>
        <div class="review-toolbar">
          <% if login? && review.user_id == current_user.id %>
            <%= link_to "編集", edit_item_review_path(@item, review) %>
            <%= link_to "削除", item_review_path(@item, review), method: :delete, data: { confirm: "本当に削除しますか？" } %>
          <% else %>
            <%= link_to "問題を報告する", report_item_review_path(@item, review), method: :patch %>
          <% end %>
      </div>
    <% end %>
  <% end %>
</div>
</html>